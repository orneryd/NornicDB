# NornicDB GraphQL Schema
# ======================
# This schema provides a complete GraphQL API for NornicDB, supporting:
# - Full CRUD operations on nodes and relationships
# - Advanced search with vector similarity and BM25
# - Cypher query pass-through for complex graph operations
# - Subscriptions for real-time updates
# - Schema introspection and graph analytics

# =============================================================================
# SCALARS
# =============================================================================

"""
Custom scalar for arbitrary JSON objects (node/edge properties)
"""
scalar JSON

"""
Custom scalar for timestamps (RFC3339 format)
"""
scalar DateTime

"""
Custom scalar for 32-bit float arrays (embeddings)
"""
scalar FloatArray

# =============================================================================
# ENUMS
# =============================================================================

"""
Memory tier classification based on cognitive science decay patterns
"""
enum MemoryTier {
  """
  Short-term memories with 7-day half-life
  """
  EPISODIC
  """
  Facts and concepts with 69-day half-life
  """
  SEMANTIC
  """
  Skills and patterns with 693-day half-life
  """
  PROCEDURAL
}

"""
Direction for relationship traversal
"""
enum RelationshipDirection {
  """
  Outgoing relationships from the node
  """
  OUTGOING
  """
  Incoming relationships to the node
  """
  INCOMING
  """
  Both directions
  """
  BOTH
}

"""
Sorting options for search results
"""
enum SearchSortBy {
  """
  Sort by relevance score (default)
  """
  RELEVANCE
  """
  Sort by creation time
  """
  CREATED_AT
  """
  Sort by last access time
  """
  LAST_ACCESSED
  """
  Sort by decay score
  """
  DECAY_SCORE
  """
  Sort by access count
  """
  ACCESS_COUNT
}

"""
Search method to use
"""
enum SearchMethod {
  """
  Hybrid RRF search combining vector and BM25
  """
  HYBRID
  """
  Vector similarity search only
  """
  VECTOR
  """
  BM25 full-text search only
  """
  BM25
}

"""
Sort order for results
"""
enum SortOrder {
  ASC
  DESC
}

# =============================================================================
# CORE TYPES
# =============================================================================

"""
A node in the NornicDB graph.

Nodes are the fundamental entities representing people, documents, concepts,
or any other domain objects. They follow the labeled property graph model
with Neo4j-compatible labels and properties.
"""
type Node {
  """
  Unique identifier (elementId format: 4:nornicdb:uuid)
  """
  id: ID!

  """
  Raw internal ID (without elementId prefix)
  """
  internalId: String!

  """
  Type labels (e.g., Person, Document, Concept)
  """
  labels: [String!]!

  """
  Key-value properties
  """
  properties: JSON!

  """
  When the node was created
  """
  createdAt: DateTime

  """
  When the node was last updated
  """
  updatedAt: DateTime

  """
  Memory decay score (1.0 = fresh, 0.0 = decayed)
  """
  decayScore: Float

  """
  When the node was last accessed
  """
  lastAccessed: DateTime

  """
  Total number of times accessed
  """
  accessCount: Int

  """
  Whether this node has an embedding vector
  """
  hasEmbedding: Boolean!

  """
  Embedding vector dimensions (0 if no embedding)
  """
  embeddingDimensions: Int!

  # Traversal fields
  """
  Relationships connected to this node
  """
  relationships(
    """
    Filter by relationship type(s)
    """
    types: [String!]
    """
    Direction of relationships
    """
    direction: RelationshipDirection = BOTH
    """
    Maximum number to return
    """
    limit: Int = 100
  ): [Relationship!]!

  """
  Outgoing relationships from this node
  """
  outgoing(types: [String!], limit: Int = 100): [Relationship!]!

  """
  Incoming relationships to this node
  """
  incoming(types: [String!], limit: Int = 100): [Relationship!]!

  """
  Connected nodes (neighbors)
  """
  neighbors(
    direction: RelationshipDirection = BOTH
    relationshipTypes: [String!]
    labels: [String!]
    limit: Int = 100
  ): [Node!]!

  """
  Find similar nodes based on embedding similarity
  """
  similar(limit: Int = 10, threshold: Float = 0.7): [SimilarNode!]!
}

"""
A relationship (edge) between two nodes.

Relationships are directed connections with a type and optional properties.
They can be manually created or auto-generated by NornicDB's inference engine.
"""
type Relationship {
  """
  Unique identifier (elementId format: 5:nornicdb:uuid)
  """
  id: ID!

  """
  Raw internal ID
  """
  internalId: String!

  """
  Relationship type (e.g., KNOWS, CITES, SIMILAR_TO)
  """
  type: String!

  """
  Source node
  """
  startNode: Node!

  """
  Target node
  """
  endNode: Node!

  """
  Key-value properties
  """
  properties: JSON!

  """
  When the relationship was created
  """
  createdAt: DateTime

  """
  When the relationship was last updated
  """
  updatedAt: DateTime

  """
  Confidence score (0.0-1.0) for auto-generated relationships
  """
  confidence: Float

  """
  Whether this was auto-generated by inference engine
  """
  autoGenerated: Boolean!
}

"""
A similar node result with similarity score
"""
type SimilarNode {
  """
  The similar node
  """
  node: Node!

  """
  Similarity score (0.0-1.0, higher = more similar)
  """
  similarity: Float!
}

# =============================================================================
# SEARCH TYPES
# =============================================================================

"""
Search result with scoring details
"""
type SearchResult {
  """
  The matched node
  """
  node: Node!

  """
  Combined RRF score
  """
  score: Float!

  """
  RRF fusion score (when using hybrid search)
  """
  rrfScore: Float

  """
  Vector similarity score (when using vector search)
  """
  vectorScore: Float

  """
  BM25 text relevance score (when using BM25 search)
  """
  bm25Score: Float

  """
  Rank in vector search results
  """
  vectorRank: Int

  """
  Rank in BM25 search results
  """
  bm25Rank: Int

  """
  Which search method found this result
  """
  foundBy: [String!]!
}

"""
Search response with results and metadata
"""
type SearchResponse {
  """
  Search results
  """
  results: [SearchResult!]!

  """
  Total number of matching results (may be > returned results)
  """
  totalCount: Int!

  """
  Search method used
  """
  method: String!

  """
  Query execution time in milliseconds
  """
  executionTimeMs: Float!

  """
  Whether vector search was available
  """
  vectorSearchUsed: Boolean!

  """
  Whether BM25 search was available
  """
  bm25SearchUsed: Boolean!
}

"""
Options for search queries
"""
input SearchOptions {
  """
  Maximum results to return
  """
  limit: Int = 10

  """
  Offset for pagination
  """
  offset: Int = 0

  """
  Filter by labels
  """
  labels: [String!]

  """
  Search method to use
  """
  method: SearchMethod = HYBRID

  """
  Minimum score threshold (0.0-1.0)
  """
  minScore: Float = 0.0

  """
  Sort results by
  """
  sortBy: SearchSortBy = RELEVANCE

  """
  Sort order
  """
  sortOrder: SortOrder = DESC

  """
  Include nodes below decay threshold
  """
  includeDecayed: Boolean = false

  """
  Minimum decay score to include
  """
  minDecayScore: Float = 0.0

  """
  Property filters (JSON object with key-value pairs)
  """
  propertyFilters: JSON
}

# =============================================================================
# CYPHER TYPES
# =============================================================================

"""
Cypher query result
"""
type CypherResult {
  """
  Column names
  """
  columns: [String!]!

  """
  Result rows (array of arrays)
  """
  rows: [[JSON!]!]!

  """
  Number of rows returned
  """
  rowCount: Int!

  """
  Query statistics
  """
  stats: CypherStats

  """
  Execution time in milliseconds
  """
  executionTimeMs: Float!
}

"""
Cypher query execution statistics
"""
type CypherStats {
  nodesCreated: Int!
  nodesDeleted: Int!
  relationshipsCreated: Int!
  relationshipsDeleted: Int!
  propertiesSet: Int!
  labelsAdded: Int!
  labelsRemoved: Int!
  containsUpdates: Boolean!
}

# =============================================================================
# GRAPH ANALYTICS TYPES
# =============================================================================

"""
Database statistics and metrics
"""
type DatabaseStats {
  """
  Total number of nodes
  """
  nodeCount: Int!

  """
  Total number of relationships
  """
  relationshipCount: Int!

  """
  Unique labels in use
  """
  labels: [LabelStats!]!

  """
  Unique relationship types in use
  """
  relationshipTypes: [RelationshipTypeStats!]!

  """
  Number of nodes with embeddings
  """
  embeddedNodeCount: Int!

  """
  Database uptime in seconds
  """
  uptimeSeconds: Float!

  """
  Memory usage in bytes
  """
  memoryUsageBytes: Int!
}

"""
Statistics for a specific label
"""
type LabelStats {
  """
  Label name
  """
  label: String!

  """
  Number of nodes with this label
  """
  count: Int!
}

"""
Statistics for a specific relationship type
"""
type RelationshipTypeStats {
  """
  Relationship type
  """
  type: String!

  """
  Number of relationships of this type
  """
  count: Int!
}

"""
Graph schema information
"""
type GraphSchema {
  """
  All node labels
  """
  nodeLabels: [String!]!

  """
  All relationship types
  """
  relationshipTypes: [String!]!

  """
  Property keys used across all nodes
  """
  nodePropertyKeys: [String!]!

  """
  Property keys used across all relationships
  """
  relationshipPropertyKeys: [String!]!

  """
  Constraints and indexes
  """
  constraints: [SchemaConstraint!]!
}

"""
Schema constraint information
"""
type SchemaConstraint {
  """
  Constraint name
  """
  name: String!

  """
  Constraint type (UNIQUE, EXISTS, etc.)
  """
  type: String!

  """
  Entity type (NODE or RELATIONSHIP)
  """
  entityType: String!

  """
  Labels or types this applies to
  """
  labelsOrTypes: [String!]!

  """
  Properties this applies to
  """
  properties: [String!]!
}

# =============================================================================
# INPUT TYPES
# =============================================================================

"""
Input for creating a new node
"""
input CreateNodeInput {
  """
  Optional custom ID (auto-generated if not provided)
  """
  id: String

  """
  Type labels
  """
  labels: [String!]!

  """
  Key-value properties
  """
  properties: JSON!

  """
  Memory tier for decay calculation
  """
  tier: MemoryTier = SEMANTIC

  """
  Pre-computed embedding vector (optional)
  """
  embedding: FloatArray
}

"""
Input for updating a node
"""
input UpdateNodeInput {
  """
  Node ID to update
  """
  id: ID!

  """
  Labels to set (replaces existing)
  """
  labels: [String!]

  """
  Properties to set/update
  """
  properties: JSON

  """
  Properties to remove by key
  """
  removeProperties: [String!]

  """
  Labels to add
  """
  addLabels: [String!]

  """
  Labels to remove
  """
  removeLabels: [String!]

  """
  Update embedding
  """
  embedding: FloatArray
}

"""
Input for creating a relationship
"""
input CreateRelationshipInput {
  """
  Optional custom ID
  """
  id: String

  """
  Source node ID
  """
  startNodeId: ID!

  """
  Target node ID
  """
  endNodeId: ID!

  """
  Relationship type
  """
  type: String!

  """
  Key-value properties
  """
  properties: JSON
}

"""
Input for updating a relationship
"""
input UpdateRelationshipInput {
  """
  Relationship ID to update
  """
  id: ID!

  """
  New relationship type
  """
  type: String

  """
  Properties to set/update
  """
  properties: JSON

  """
  Properties to remove by key
  """
  removeProperties: [String!]
}

"""
Input for bulk node creation
"""
input BulkCreateNodesInput {
  """
  Nodes to create
  """
  nodes: [CreateNodeInput!]!

  """
  Skip duplicates instead of failing
  """
  skipDuplicates: Boolean = false
}

"""
Input for bulk relationship creation
"""
input BulkCreateRelationshipsInput {
  """
  Relationships to create
  """
  relationships: [CreateRelationshipInput!]!

  """
  Skip invalid references instead of failing
  """
  skipInvalid: Boolean = false
}

"""
Input for Cypher query execution
"""
input CypherInput {
  """
  Cypher statement
  """
  statement: String!

  """
  Query parameters
  """
  parameters: JSON

  """
  Timeout in milliseconds
  """
  timeoutMs: Int
}

# =============================================================================
# QUERIES
# =============================================================================

type Query {
  # ------ Node Queries ------

  """
  Get a node by ID
  """
  node(id: ID!): Node

  """
  Get multiple nodes by IDs
  Returns empty array if ids is not provided or empty
  """
  nodes(ids: [ID!]): [Node!]!

  """
  Get all nodes with optional filtering
  """
  allNodes(labels: [String!], limit: Int = 100, offset: Int = 0): [Node!]!

  """
  Get nodes by label
  """
  nodesByLabel(label: String!, limit: Int = 100, offset: Int = 0): [Node!]!

  """
  Count nodes (optionally by label)
  """
  nodeCount(label: String): Int!

  # ------ Relationship Queries ------

  """
  Get a relationship by ID
  """
  relationship(id: ID!): Relationship

  """
  Get all relationships with optional filtering
  """
  allRelationships(
    types: [String!]
    limit: Int = 100
    offset: Int = 0
  ): [Relationship!]!

  """
  Get relationships by type
  """
  relationshipsByType(
    type: String!
    limit: Int = 100
    offset: Int = 0
  ): [Relationship!]!

  """
  Get relationships between two nodes
  """
  relationshipsBetween(startNodeId: ID!, endNodeId: ID!): [Relationship!]!

  """
  Count relationships (optionally by type)
  """
  relationshipCount(type: String): Int!

  # ------ Search Queries ------

  """
  Perform hybrid search (vector + BM25)
  """
  search(query: String!, options: SearchOptions): SearchResponse!

  """
  Find nodes similar to a given node
  """
  similar(nodeId: ID!, limit: Int = 10, threshold: Float = 0.7): [SimilarNode!]!

  """
  Search nodes by property value
  """
  searchByProperty(
    key: String!
    value: JSON!
    labels: [String!]
    limit: Int = 100
  ): [Node!]!

  # ------ Cypher Queries ------

  """
  Execute a Cypher query
  """
  cypher(input: CypherInput!): CypherResult!

  # ------ Schema & Analytics ------

  """
  Get database statistics
  """
  stats: DatabaseStats!

  """
  Get graph schema information
  """
  schema: GraphSchema!

  """
  Get all unique labels
  """
  labels: [String!]!

  """
  Get all unique relationship types
  """
  relationshipTypes: [String!]!

  # ------ Graph Traversal Queries ------

  """
  Find shortest path between two nodes
  """
  shortestPath(
    startNodeId: ID!
    endNodeId: ID!
    maxDepth: Int = 10
    relationshipTypes: [String!]
  ): [Node!]

  """
  Find all paths between two nodes
  """
  allPaths(
    startNodeId: ID!
    endNodeId: ID!
    maxDepth: Int = 5
    limit: Int = 10
  ): [[Node!]!]!

  """
  Get node neighborhood (subgraph)
  """
  neighborhood(
    nodeId: ID!
    depth: Int = 1
    relationshipTypes: [String!]
    labels: [String!]
    limit: Int = 100
  ): Subgraph!
}

"""
A subgraph containing nodes and relationships
"""
type Subgraph {
  """
  Nodes in the subgraph
  """
  nodes: [Node!]!

  """
  Relationships in the subgraph
  """
  relationships: [Relationship!]!
}

# =============================================================================
# MUTATIONS
# =============================================================================

type Mutation {
  # ------ Node Mutations ------

  """
  Create a new node
  """
  createNode(input: CreateNodeInput!): Node!

  """
  Update an existing node
  """
  updateNode(input: UpdateNodeInput!): Node!

  """
  Delete a node
  """
  deleteNode(id: ID!): Boolean!

  """
  Bulk create nodes
  """
  bulkCreateNodes(input: BulkCreateNodesInput!): BulkCreateResult!

  """
  Bulk delete nodes
  """
  bulkDeleteNodes(ids: [ID!]!): BulkDeleteResult!

  """
  Merge a node (create or update)
  """
  mergeNode(
    labels: [String!]!
    matchProperties: JSON!
    setProperties: JSON
  ): Node!

  # ------ Relationship Mutations ------

  """
  Create a new relationship
  """
  createRelationship(input: CreateRelationshipInput!): Relationship!

  """
  Update an existing relationship
  """
  updateRelationship(input: UpdateRelationshipInput!): Relationship!

  """
  Delete a relationship
  """
  deleteRelationship(id: ID!): Boolean!

  """
  Bulk create relationships
  """
  bulkCreateRelationships(
    input: BulkCreateRelationshipsInput!
  ): BulkCreateResult!

  """
  Bulk delete relationships
  """
  bulkDeleteRelationships(ids: [ID!]!): BulkDeleteResult!

  """
  Merge a relationship (create or update)
  """
  mergeRelationship(
    startNodeId: ID!
    endNodeId: ID!
    type: String!
    properties: JSON
  ): Relationship!

  # ------ Cypher Mutations ------

  """
  Execute a Cypher mutation
  """
  executeCypher(input: CypherInput!): CypherResult!

  # ------ Maintenance Mutations ------

  """
  Trigger embedding generation for nodes without embeddings
  """
  triggerEmbedding(regenerate: Boolean = false): EmbeddingStatus!

  """
  Rebuild search indexes
  """
  rebuildSearchIndex: Boolean!

  """
  Run memory decay simulation
  """
  runDecay: DecayResult!

  """
  Clear all data (dangerous!)
  """
  clearAll(confirmPhrase: String!): Boolean!
}

"""
Result of bulk create operation
"""
type BulkCreateResult {
  """
  Number of items successfully created
  """
  created: Int!

  """
  Number of items skipped
  """
  skipped: Int!

  """
  Errors encountered (if any)
  """
  errors: [String!]!
}

"""
Result of bulk delete operation
"""
type BulkDeleteResult {
  """
  Number of items successfully deleted
  """
  deleted: Int!

  """
  IDs that were not found
  """
  notFound: [ID!]!
}

"""
Embedding generation status
"""
type EmbeddingStatus {
  """
  Number of nodes pending embedding
  """
  pending: Int!

  """
  Number of nodes with embeddings
  """
  embedded: Int!

  """
  Total node count
  """
  total: Int!

  """
  Whether embedding worker is running
  """
  workerRunning: Boolean!
}

"""
Memory decay simulation result
"""
type DecayResult {
  """
  Number of nodes processed
  """
  nodesProcessed: Int!

  """
  Number of nodes that decayed below threshold
  """
  nodesDecayed: Int!

  """
  Average decay score after simulation
  """
  averageDecayScore: Float!
}

# =============================================================================
# SUBSCRIPTIONS
# =============================================================================

type Subscription {
  """
  Subscribe to node creation events
  """
  nodeCreated(labels: [String!]): Node!

  """
  Subscribe to node update events
  """
  nodeUpdated(id: ID, labels: [String!]): Node!

  """
  Subscribe to node deletion events
  """
  nodeDeleted(labels: [String!]): ID!

  """
  Subscribe to relationship creation events
  """
  relationshipCreated(types: [String!]): Relationship!

  """
  Subscribe to relationship update events
  """
  relationshipUpdated(id: ID, types: [String!]): Relationship!

  """
  Subscribe to relationship deletion events
  """
  relationshipDeleted(types: [String!]): ID!

  """
  Subscribe to search results (streaming results)
  """
  searchStream(query: String!, options: SearchOptions): SearchResult!
}
