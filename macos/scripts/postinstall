#!/bin/bash

# NornicDB Post-Install Script
# Runs after .pkg installation to set up user-specific files

set -e

# Get the actual user (not root, since installer runs as root)
ACTUAL_USER="${USER}"
if [ "$ACTUAL_USER" = "root" ]; then
    ACTUAL_USER=$(ls -l /dev/console | awk '{print $3}')
fi

USER_HOME=$(eval echo ~$ACTUAL_USER)
USER_UID=$(id -u $ACTUAL_USER)

echo "Setting up NornicDB for user: $ACTUAL_USER"

# Create user directories
# Create config directories - use ~/.nornicdb to match server's FindConfigFile priority
mkdir -p "$USER_HOME/.nornicdb"
mkdir -p "$USER_HOME/Library/LaunchAgents"
chown $ACTUAL_USER:staff "$USER_HOME/.nornicdb"
chown $ACTUAL_USER:staff "$USER_HOME/Library/LaunchAgents"

# Create data, models, and log directories (as root, will set ownership later)
mkdir -p /usr/local/var/nornicdb/data
mkdir -p /usr/local/var/nornicdb/models
mkdir -p /usr/local/var/log/nornicdb

# Set ownership
chown -R $ACTUAL_USER:staff /usr/local/var/nornicdb
chown -R $ACTUAL_USER:staff /usr/local/var/log/nornicdb

echo "  ✓ Created directories:"
echo "    - /usr/local/var/nornicdb/data (database)"
echo "    - /usr/local/var/nornicdb/models (AI models)"
echo "    - /usr/local/var/log/nornicdb (logs)"

# Copy default config if it doesn't exist
if [ ! -f "$USER_HOME/.nornicdb/config.yaml" ]; then
    # Config should be bundled in package, copy from Resources
    RESOURCES_PATH="$2/Contents/Resources"
    if [ -f "$RESOURCES_PATH/default-config.yaml" ]; then
        sudo -u $ACTUAL_USER cp "$RESOURCES_PATH/default-config.yaml" \
            "$USER_HOME/.nornicdb/config.yaml"
        echo "✓ Installed default configuration from package"
    elif [ -f "$RESOURCES_PATH/nornicdb.example.yaml" ]; then
        sudo -u $ACTUAL_USER cp "$RESOURCES_PATH/nornicdb.example.yaml" \
            "$USER_HOME/.nornicdb/config.yaml"
        echo "✓ Installed default configuration (fallback)"
    else
        # Create minimal config (write as root, fix ownership after)
        cat > "$USER_HOME/.nornicdb/config.yaml" << 'EOF'
# NornicDB Configuration
# Edit via Settings app (⌘,) or manually

server:
  port: 7687
  host: "localhost"
  auth: "admin:admin"

storage:
  path: "/usr/local/var/nornicdb/data"

embedding:
  enabled: false
  provider: "local"

kmeans:
  enabled: false

auto_tlp:
  enabled: false

heimdall:
  enabled: false
EOF
        chown $ACTUAL_USER:staff "$USER_HOME/.nornicdb/config.yaml"
        echo "✓ Created minimal configuration"
    fi
fi

# NOTE: We do NOT create the server LaunchAgent plist here!
# The plist will be created by the menu bar app when the user completes
# the first-run wizard. This ensures:
# 1. User can configure encryption BEFORE any data is written
# 2. launchd's KeepAlive doesn't auto-start the server prematurely

# Make absolutely sure no old service is running
sudo -u $ACTUAL_USER launchctl bootout gui/$USER_UID/com.nornicdb.server 2>/dev/null || true
sudo -u $ACTUAL_USER launchctl remove com.nornicdb.server 2>/dev/null || true
pkill -9 -f "nornicdb serve" 2>/dev/null || true

# Remove any existing server plist to prevent auto-start
rm -f "$USER_HOME/Library/LaunchAgents/com.nornicdb.server.plist" 2>/dev/null || true

echo "✓ Server will start after first-run wizard completes"

# Install menu bar app LaunchAgent for auto-start
# Write as root first, then fix ownership
cat > "$USER_HOME/Library/LaunchAgents/com.nornicdb.menubar.plist" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.nornicdb.menubar</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/open</string>
        <string>-a</string>
        <string>/Applications/NornicDB.app</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <false/>
    <key>ProcessType</key>
    <string>Interactive</string>
</dict>
</plist>
EOF

# Fix ownership so user can load it
chown $ACTUAL_USER:staff "$USER_HOME/Library/LaunchAgents/com.nornicdb.menubar.plist"

# Load the menu bar app LaunchAgent as the user
sudo -u $ACTUAL_USER launchctl load "$USER_HOME/Library/LaunchAgents/com.nornicdb.menubar.plist" 2>/dev/null || true

# Launch menu bar app immediately
sudo -u $ACTUAL_USER open -a "/Applications/NornicDB.app" 2>/dev/null || true
echo "✓ Launched menu bar app (will auto-start on login)"

# Create welcome file to trigger first-run wizard
touch "$USER_HOME/.nornicdb/.first_run"
chown $ACTUAL_USER:staff "$USER_HOME/.nornicdb/.first_run"

echo ""
echo "✅ NornicDB installation complete!"
echo ""
echo "The menu bar app should now be running."
echo "Look for the database icon in your menu bar (top right)."
echo ""
echo "IMPORTANT: The database server will NOT start until you complete the"
echo "first-time setup wizard. This allows you to configure encryption"
echo "BEFORE any data is written to disk."
echo ""
echo "Click the menu bar icon to begin setup."
echo ""

exit 0
