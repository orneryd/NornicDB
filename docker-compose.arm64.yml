services:
  nornicdb:
    build:
      context: ./nornicdb
      dockerfile: docker/Dockerfile.arm64-metal
      args:
        EMBED_MODEL: "true"  # Include bge-m3.gguf in image
      tags:
        - timothyswt/nornicdb-arm64-metal-bge:latest
    image: timothyswt/nornicdb-arm64-metal-bge:latest
    container_name: nornicdb
    volumes:
      - ./data/movies-test:/data
    ports:
      - "7474:7474" # HTTP API & Browser UI
      - "7687:7687" # Bolt protocol (Neo4j compatible)
    environment:
      - NORNICDB_DATA_DIR=/data
      - NORNICDB_HTTP_PORT=7474
      - NORNICDB_BOLT_PORT=7687
      # Embedding configuration - llama.cpp OpenAI-compatible API
      # - NORNICDB_HEIMDALL_ENABLED=true
      - NORNICDB_AUTO_TLP_ENABLED=false
      # - NORNICDB_KMEANS_CLUSTERING_ENABLED=true
      - NORNICDB_EMBEDDING_PROVIDER=local
      - NORNICDB_NO_AUTH=${NORNICDB_NO_AUTH:-true}
      - GOGC=50
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD-SHELL", "wget --spider -q http://localhost:7474/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - mcp_network
    deploy:
      resources:
        limits:
          memory: 2GB
        reservations:
          memory: 1GB
networks:
  mcp_network:
    driver: bridge
